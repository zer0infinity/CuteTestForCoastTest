from pkg_resources import require as pkg_require
pkg_require(["SConsider<0.5"])
import os
import re
import sys
import shlex
import SConsider
import Anything
from stat import *
from SomeUtils import multiple_replace, runCommand

Import('*')

defaults = None


def ModifyConfigFiles(env, searchReplace=[], files=[]):
    for file in files:
        fname = file.abspath
        if os.path.isfile(fname):
            oldmode = os.stat(fname).st_mode
            # set writable
            os.chmod(fname, oldmode | S_IWUSR)
            # replace tokens in file
            SConsider.replaceRegexInFile(fname, searchReplace)
            os.chmod(fname, oldmode)


def setUp(target, source, env):
    target = SConsider.packageRegistry.getPackageTarget('sybase', 'isql')
    if not target:
        raise SConsider.SkipTest(
            'required isql executable not found, skipping test')

    relDir = env['BASEOUTDIR'].Dir(env['RELTARGETDIR'])
    logDir = relDir.Dir(env['LOGDIR']).Dir(env['VARIANTDIR'])
    configdir = relDir.Dir('config')
    Anything.setLocalEnv(env={}, COAST_ROOT=relDir.abspath)
    global defaults
    try:
        defaults = Anything.loadFromFile('Defaults.any')
    except IOError:
        pass
    if not defaults or 'Sybase' not in defaults:
        raise SConsider.SkipTest('sybase backend not configured')

    searchreplacespec = [
        ('##database##', str(defaults['Sybase']['Database'])),
        ('##server##', str(defaults['Sybase']['Server'])),
        ('##hostname##', str(defaults['Sybase']['Hostname'])),
        ('##port##', str(defaults['Sybase']['Port'])),
        ('##username##', str(defaults['Sybase']['Username'])),
        ('##password##', str(defaults['Sybase']['Password'])),
    ]

    ModifyConfigFiles(
        env,
        searchreplacespec,
        SConsider.findFiles(
            [configdir],
            matchfiles=['interfaces']))

    command = [target.abspath]
    command.extend(shlex.split(
        "-U {Username!s} -P {Password!s} -S {Server!s}".format(**defaults['Sybase'])))
    command.extend(['-I', configdir.File('interfaces').abspath])
    res = runCommand(
        command,
        logpath=logDir.abspath,
        filename=configdir.File('dropPub2.sql').abspath,
        filter=lambda string: multiple_replace(searchreplacespec, string),
        env=SConsider.getFlatENV(env)
    )
    if res != 0:
        raise SConsider.SkipTest(
            'failed to drop test database (rc=' +
            str(res) +
            '), check error log')
    res = runCommand(
        command,
        logpath=logDir.abspath,
        filename=configdir.File('createPub2.sql').abspath,
        filter=lambda string: multiple_replace(searchreplacespec, string),
        env=SConsider.getFlatENV(env)
    )
    if res != 0:
        raise SConsider.SkipTest(
            'failed to create test database (rc=' +
            str(res) +
            '), check error log')


def tearDown(target, source, env):
    pass

buildSettings = {
    packagename: {
        'targetType': 'ProgramTest',
        'linkDependencies': [
            'CoastSybaseCT',
            'testfwWDBase',
        ],
        'requires': [
            'CoastActions',
            SConsider.generateFulltargetname('sybase', 'isql'),
        ],
        'sourceFiles': SConsider.listFiles(['*.cpp']),
        'copyFiles': [
            (SConsider.listFiles(
                ['config/*.any', 'config/*.sql', 'config/interfaces']), S_IRUSR | S_IRGRP | S_IROTH),
        ],
        'runConfig': {
            'setUp': setUp,
            'tearDown': tearDown,
        },
    },
}

SConsider.createTargets(packagename, buildSettings)
